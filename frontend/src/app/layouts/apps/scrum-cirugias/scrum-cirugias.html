<div>
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">Agenda de Pabellones</h2>
    </div>

    <div class="-mx-2 overflow-x-auto">
        <div class="flex flex-nowrap gap-5 px-2 pb-2">

            <!-- COLUMNAS: PABELLONES -->
            <ng-container *ngIf="pabellones?.length">
                <ng-container *ngFor="let pab of pabellones">
                    <div class="panel w-80 flex-none p-4">

                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <h4 class="text-lg font-bold">{{ pab.nombre }}</h4>
                                <div class="text-xs text-gray-500">
                                    Cirugías: {{ pab.tasks?.length || 0 }} · Min totales: {{ getTotalMinutos(pab) }}
                                </div>
                            </div>

                            <button type="button" class="btn btn-sm btn-primary" (click)="editarCirugia(pab.id)">
                                <icon-plus class="h-4 w-4" />
                            </button>
                        </div>

                        <!-- LISTA DE CIRUGÍAS (DRAG & DROP) -->
                        <div [sortablejs]="pab.tasks || []" [sortablejsOptions]="sortableOptionsFor(pab.id)"
                            class="min-h-[150px]">
                            <div *ngFor="let cir of pab.tasks"
                                class="mb-4 cursor-move p-3 rounded-md shadow relative dark:bg-white-dark/20"
                                [ngClass]="getCardClasses(cir)" [attr.data-cirugia-id]="cir.id">
                                <div class="font-semibold text-sm mb-1">
                                    {{ getTipoNombre(cir.tipo_cirugia_id) }}
                                </div>

                                <div *ngIf="!cir.es_aseo" class="text-xs text-gray-700 mb-1">
                                    Paciente: <strong>{{ getPacienteNombre(cir.paciente_id) }}</strong>
                                </div>

                                <div *ngIf="cir.es_aseo" class="text-xs text-gray-700 mb-1 italic">
                                    Aseo posterior a cirugía
                                </div>

                                <div *ngIf="!cir.es_aseo" class="text-xs mb-1">
                                    Doctor: <strong>{{ getDoctorNombre(cir.doctor_id) }}</strong>
                                </div>

                                <div *ngIf="cir.es_aseo" class="text-xs mb-1 italic text-gray-700">
                                    Equipo de aseo
                                </div>

                                <div class="text-xs">
                                    Fecha: {{ cir.fecha }}
                                </div>
                                <div class="text-xs">
                                    Inicio: {{ cir.hora_inicio }}
                                </div>
                                <div class="text-xs">
                                    Fin estimado: {{ cir.hora_fin_estimada | date:'shortTime' }}
                                </div>
                                <div class="text-xs">
                                    Extra: <strong>{{ cir.extra_time }} min</strong>
                                </div>
                                <div class="text-xs">
                                    Estado: <strong>{{ cir.estado }}</strong>
                                </div>

                                <div class="flex justify-between mt-3" *ngIf="!cir.es_aseo">
                                    <button class="btn btn-xs btn-outline-info" type="button"
                                        (click)="editarCirugia(pab.id, cir)">
                                        Editar
                                    </button>

                                    <button class="btn btn-xs btn-outline-warning" type="button"
                                        (click)="agregarExtraTime(cir)">
                                        + Tiempo
                                    </button>

                                    <button class="btn btn-xs btn-outline-danger" type="button"
                                        (click)="eliminarCirugia(cir)">
                                        X
                                    </button>
                                </div>

                                <!-- Opcional: etiqueta visible en las tarjetas de ASEO -->
                                <div *ngIf="cir.es_aseo" class="mt-3 text-xs font-semibold text-sky-700">
                                    Limpieza / Aseo
                                </div>
                            </div>
                        </div>

                    </div>
                </ng-container>
            </ng-container>
        </div>
    </div>

    <!-- MODAL CREAR / EDITAR CIRUGÍA -->
    <modal #isAddCirugiaModal class="no-footer">
        <ng-template #modalHeader>
            <div class="!font-medium">
                {{ paramsCirugia.id ? 'Editar Cirugía' : 'Agregar Cirugía' }}
            </div>
        </ng-template>

        <ng-template #modalBody>
            <form (ngSubmit)="guardarCirugia()" class="text-sm">

                <div class="mb-3">
                    <label class="block mb-1">Paciente</label>
                    <select class="form-select" [(ngModel)]="paramsCirugia.paciente_id" name="paciente_id">
                        <option [ngValue]="null">Seleccione...</option>
                        <option *ngFor="let p of pacientes" [ngValue]="p.id">
                            {{ p.nombre }} ({{ p.rut }})
                        </option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="block mb-1">Doctor</label>
                    <select class="form-select" [(ngModel)]="paramsCirugia.doctor_id" name="doctor_id">
                        <option [ngValue]="null">Seleccione...</option>
                        <option *ngFor="let d of doctores" [ngValue]="d.id">
                            {{ d.nombre_completo }} ({{ d.username }})
                        </option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="block mb-1">Tipo de cirugía</label>
                    <select class="form-select" [(ngModel)]="paramsCirugia.tipo_cirugia_id" name="tipo_cirugia_id">
                        <option [ngValue]="null">Seleccione...</option>
                        <option *ngFor="let t of tiposCirugia" [ngValue]="t.id">
                            {{ t.nombre }} · {{ t.duracion_estimada }} min
                        </option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="block mb-1">Fecha</label>
                    <input type="date" class="form-input" [(ngModel)]="paramsCirugia.fecha" name="fecha" />
                </div>

                <div class="mb-3">
                    <label class="block mb-1">Hora inicio</label>
                    <input type="time" class="form-input" [(ngModel)]="paramsCirugia.hora_inicio" name="hora_inicio" />
                </div>

                <div class="mb-3">
                    <label class="block mb-1">Duración programada (min)</label>
                    <input type="number" class="form-input" [(ngModel)]="paramsCirugia.duracion_programada"
                        name="duracion_programada" />
                    <p class="text-xs text-gray-500 mt-1">
                        Si se deja vacío, se usará la duración estimada del tipo de cirugía.
                    </p>
                </div>

                <div class="mb-3">
                    <label class="block mb-1">Tiempo extra (min)</label>
                    <input type="number" class="form-input" [(ngModel)]="paramsCirugia.extra_time" name="extra_time" />
                </div>

                <div class="mt-6 flex justify-end">
                    <button type="button" class="btn btn-outline-danger" (click)="isAddCirugiaModal.close()">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary ltr:ml-4 rtl:mr-4">
                        {{ paramsCirugia.id ? 'Actualizar' : 'Agregar' }}
                    </button>
                </div>
            </form>
        </ng-template>
    </modal>
</div>